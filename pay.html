<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment - Fine Graphics</title>
  
  <style>
    /* Your existing CSS styles */
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f5f5f5; 
    }
    
    header { 
      background: #007bff; 
      color: white; 
      padding: 15px; 
      text-align: center; 
      font-size: 22px; 
    }
    
    .container { 
      max-width: 700px; 
      margin: 30px auto; 
      background: white; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
    }

    .order-item {
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding: 15px 0;
    }
    
    .order-item img {
      width: 120px;
      height: 120px;
      border-radius: 10px;
      margin-right: 20px;
      object-fit: cover;
    }
    
    .details { 
      flex: 1; 
    }
    
    .details h2 { 
      margin: 5px 0; 
      font-size: 20px; 
    }
    
    .details p { 
      margin: 5px 0; 
      color: #333; 
      font-size: 16px; 
    }

    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #218838;
    }
    
    .btn:disabled { 
      background: gray; 
      cursor: not-allowed; 
    }
    
    .btn-secondary {
      background: #007bff;
    }
    
    .btn-secondary:hover {
      background: #0056b3;
    }

    #qrcode { 
      text-align: center; 
      margin-top: 20px; 
    }
    
    #qrcode img { 
      max-width: 220px; 
      border: 4px solid #007bff; 
      border-radius: 12px; 
    }

    #successBox {
      display: none;
      text-align: center;
      padding: 30px;
      margin-top: 20px;
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
      border-radius: 10px;
      font-size: 20px;
      font-weight: bold;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #007bff;
      font-size: 16px;
    }
    
    .error {
      text-align: center;
      padding: 20px;
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .upi-details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .upi-details h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .upi-details p {
      margin: 5px 0;
      font-size: 16px;
    }

    .price-breakdown {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .price-line {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 16px;
    }
    
    .price-total {
      border-top: 2px solid #007bff;
      padding-top: 10px;
      margin-top: 10px;
      font-weight: bold;
      font-size: 20px;
    }

    .success-animation {
      animation: bounce 0.5s;
    }
    
    @keyframes bounce {
      0%, 20%, 60%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      80% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>

  <header>Confirm Payment</header>

  <div class="container" id="orderContainer">
    <div class="loading">Loading your order...</div>
  </div>
  
  <div class="container">
    <div class="price-breakdown" id="priceBreakdown">
      <h3>üí∞ Price Breakdown</h3>
      <div class="price-line"><span>Subtotal:</span><span>‚Çπ0.00</span></div>
      <div class="price-line"><span>Shipping:</span><span>‚Çπ0.00</span></div>
      <div class="price-line"><span>GST (18%):</span><span>‚Çπ0.00</span></div>
      <div class="price-line price-total"><span>Total Amount:</span><span>‚Çπ0.00</span></div>
    </div>
    
    <div class="upi-details">
      <h3>üí≥ Payment Information</h3>
      <p><strong>UPI ID:</strong> dharneeshdragons@okhdfcbank</p>
      <p><strong>Payee Name:</strong> Fine Graphics</p>
      <p><strong>Note:</strong> Scan QR code or use UPI ID to pay. Order will be confirmed after payment.</p>
    </div>
    
    <button id="payBtn" class="btn">Generate QR Code & Pay</button>
    <div id="qrcode"></div>
    <button id="paidBtn" class="btn btn-secondary" style="display:none;">‚úÖ I Have Paid - Confirm Order</button>
    <div id="successBox">‚úÖ Payment Successful! Order Saved. Redirecting...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    let currentUser = null;
    let checkout = null;
    let subtotal = 0;
    let tax = 0;
    let total = 0;

    async function initPayment() {
      try {
        const userData = localStorage.getItem("currentUser");
        if (!userData) return showError("Please login first!"), setTimeout(()=>location.href="login.html",2000);
        currentUser = JSON.parse(userData);
        const username = currentUser.username || currentUser.email;

        const checkoutData = localStorage.getItem("checkout_" + username);
        if (!checkoutData) return showError("No items found for checkout."), setTimeout(()=>location.href="index.html",2000);

        checkout = JSON.parse(checkoutData);
        if (!checkout.items || checkout.items.length === 0) return showError("No items to pay.");

        subtotal = checkout.subtotal || checkout.items.reduce((s, i)=>s + (i.price * i.quantity), 0);
        tax = checkout.tax || subtotal * 0.18;
        total = checkout.total || subtotal + tax;

        renderOrderItems();
        updatePriceBreakdown();
        setupEventListeners();
      } catch (e) {
        showError("Error loading payment page: " + e.message);
      }
    }

    function setupEventListeners() {
      document.getElementById("payBtn").addEventListener("click", handlePayment);
      document.getElementById("paidBtn").addEventListener("click", handleOrderSave);
    }

    function updatePriceBreakdown() {
      const b = document.getElementById("priceBreakdown");
      b.innerHTML = `
        <h3>üí∞ Price Breakdown</h3>
        <div class="price-line"><span>Subtotal:</span><span>‚Çπ${subtotal.toFixed(2)}</span></div>
        <div class="price-line"><span>Shipping:</span><span>‚Çπ0.00</span></div>
        <div class="price-line"><span>GST (18%):</span><span>‚Çπ${tax.toFixed(2)}</span></div>
        <div class="price-line price-total"><span>Total Amount:</span><span>‚Çπ${total.toFixed(2)}</span></div>
      `;
    }

    function renderOrderItems() {
      const c = document.getElementById("orderContainer");
      if (!checkout || !checkout.items || checkout.items.length === 0) {
        c.innerHTML = "<div class='error'>No items found for payment.</div>";
        document.getElementById("payBtn").disabled = true;
        return;
      }
      let html = "<h2>üì¶ Your Order Summary</h2>";
      checkout.items.forEach(item => {
        const itemSubtotal = item.price * item.quantity;
        const hasCustomization = item.placement_position || item.custom_requirements;
        html += `
          <div class="order-item">
            <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/120?text=No+Image'">
            <div class="details">
              <h2>${item.name}</h2>
              <p><strong>Price:</strong> ‚Çπ${item.price}</p>
              <p><strong>Quantity:</strong> ${item.quantity}</p>
              ${hasCustomization ? `
                <div style="background:#f0f8ff;padding:10px;border-radius:5px;margin:10px 0;border-left:3px solid #007bff;">
                  ${item.placement_position ? `<p>üìç ${(item.design_side||'front').toUpperCase()} - ${item.placement_position}</p>`:''}
                  ${(item.design_width>0 && item.design_height>0)?`<p>üìè ${item.design_width}cm √ó ${item.design_height}cm</p>`:''}
                  ${item.custom_requirements?`<p>üìù ${item.custom_requirements}</p>`:''}
                </div>`:''}
              <p><strong>Subtotal:</strong> ‚Çπ${itemSubtotal.toFixed(2)}</p>
            </div>
          </div>`;
      });
      c.innerHTML = html;
    }

    function handlePayment() {
      const upiID = "dharneeshdragons@okhdfcbank";
      const payeeName = "Fine Graphics";
      const upiLink = `upi://pay?pa=${upiID}&pn=${encodeURIComponent(payeeName)}&am=${total}&cu=INR`;

      const qr = document.getElementById("qrcode");
      qr.innerHTML = "<div class='loading'>Generating QR Code...</div>";
      QRCode.toDataURL(upiLink,{width:220,margin:2},(err,url)=>{
        if(err)return qr.innerHTML="<div class='error'>Failed to generate QR code</div>";
        qr.innerHTML = `
          <h3>üì± Scan QR Code to Pay</h3>
          <img src="${url}">
          <p><strong>Amount:</strong> ‚Çπ${total.toFixed(2)}</p>
          <p><em>After payment, click 'I Have Paid' below</em></p>`;
      });
      document.getElementById("paidBtn").style.display="block";
      document.getElementById("payBtn").style.display="none";
      setTimeout(()=>window.location.href=upiLink,1000);
    }

    async function handleOrderSave() {
      try {
        const username = currentUser.username || currentUser.email;
        const paidBtn = document.getElementById("paidBtn");
        const successBox = document.getElementById("successBox");
        paidBtn.disabled = true;
        paidBtn.textContent = "üíæ Saving Order...";

        const orderData = {
          username,
          items: checkout.items,
          subtotal, tax, total,
          orderDate: new Date().toISOString(),
          status: "confirmed"
        };

        // ‚úÖ Remove purchased items first
        await removePurchasedItemsFromCart();

        // ‚úÖ Re-render after clearing
        renderOrderItems();
        updatePriceBreakdown();

        // Simulate backend call
        const result = { success: true, orderId: "FG" + Date.now() };

        if (result.success) {
          successBox.style.display = "block";
          successBox.classList.add("success-animation");
          successBox.innerHTML = `
            ‚úÖ <strong>Payment Successful!</strong><br>
            üì¶ Order ID: ${result.orderId}<br>
            üõí Items removed from cart<br>
            üîÑ Redirecting to orders page...
          `;
          localStorage.removeItem("checkout_" + username);
          setTimeout(()=>location.href="orders.html",2000);
        } else {
          showError("Failed to save order.");
        }
      } catch (err) {
        showError("Error saving order: " + err.message);
      }
    }

    async function removePurchasedItemsFromCart() {
      try {
        const username = currentUser.username || currentUser.email;
        const cartKey = "cart_" + username;
        const savedCart = localStorage.getItem(cartKey);
        if (!savedCart) return;
        let cart = JSON.parse(savedCart);
        const newCart = cart.filter(cartItem => 
          !checkout.items.some(p => 
            cartItem.name === p.name &&
            cartItem.placement_position === p.placement_position &&
            cartItem.custom_requirements === p.custom_requirements
          )
        );
        localStorage.setItem(cartKey, JSON.stringify(newCart));
      } catch (e) {
        console.error("Cart remove error:", e);
      }
    }

    function showError(msg) {
      const c = document.getElementById("orderContainer");
      const d = document.createElement("div");
      d.className="error";
      d.innerHTML = `
        <strong>‚ùå Error:</strong> ${msg}<br><br>
        <button onclick="window.location.href='index.html'" class="btn" style="background:#dc3545;">üè† Home</button>
        <button onclick="location.reload()" class="btn" style="background:#ffc107;color:black;">üîÑ Retry</button>`;
      c.appendChild(d);
    }

    document.addEventListener("DOMContentLoaded", initPayment);
  </script>
</body>
</html>